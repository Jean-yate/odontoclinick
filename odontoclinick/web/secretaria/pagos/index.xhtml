<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                template="/WEB-INF/templates/plantilla.xhtml">

    <ui:define name="titulo">Gestión de Pagos</ui:define>

    <ui:define name="contenido">
        
        <h:form id="formPagos">
            <p:panel header="Listado de Pagos Recibidos">

                <div style="text-align: right; margin-bottom: 15px;">
                    <p:commandButton value="Registrar Pago" icon="pi pi-dollar" 
                                     actionListener="#{pagoBean.resetFormulario()}"
                                     update=":dialogoPago" oncomplete="PF('wDialogoPago').show();"
                                     styleClass="ui-button-primary" />
                </div>

                <p:dataTable id="tablaPagos" value="#{pagoBean.listaPagos}" var="pago"
                             paginator="true" rows="10" emptyMessage="No hay pagos registrados."
                             rowKey="#{pago.idPago}">

                    <p:column headerText="ID Pago" width="80" style="text-align: center;">
                        <h:outputText value="#{pago.idPago}" />
                    </p:column>

                    <p:column headerText="Paciente" filterBy="#{pago.cita.paciente.usuario.nombre}" filterMatchMode="contains">
                        <h:outputText value="Cita ##{pago.idCita}" /> 
                    </p:column>

                    <p:column headerText="Monto">
                        <h:outputText value="#{pago.monto}">
                            <f:convertNumber type="currency" currencySymbol="$" maxFractionDigits="0" />
                        </h:outputText>
                    </p:column>

                    <p:column headerText="Fecha">
                        <h:outputText value="#{pago.fechaPago}">
                            <f:convertDateTime pattern="dd/MM/yyyy HH:mm" />
                        </h:outputText>
                    </p:column>

                    <p:column headerText="Método">
                        <h:outputText value="#{pago.idMetodoPago == 1 ? 'Efectivo' : (pago.idMetodoPago == 2 ? 'T. Crédito' : 'Otro')}" />
                    </p:column>
                    
                    <p:column headerText="Referencia">
                        <h:outputText value="#{pago.referencia}" />
                    </p:column>

                    <p:column headerText="Acciones" style="text-align: center; width: 100px;">
                        <p:commandButton icon="pi pi-print" title="Imprimir Recibo"
                                         styleClass="ui-button-secondary ui-button-flat"
                                         type="button" onclick="alert('Funcionalidad de imprimir pendiente de implementar');"/>
                    </p:column>

                </p:dataTable>
            </p:panel>
        </h:form>

        <p:dialog id="dialogoPago" widgetVar="wDialogoPago" header="Registrar Nuevo Pago" 
                  modal="true" resizable="false" width="500">
            <h:form>
                <p:messages showDetail="true" closable="true" />
                
                <h:panelGrid columns="2" cellpadding="5" style="width: 100%">
                    
                    <p:outputLabel for="cita" value="Cita a Pagar:" />
                    <p:selectOneMenu id="cita" value="#{pagoBean.pagoActual.idCita}" required="true" filter="true" filterMatchMode="contains" style="width: 100%">
                        <f:selectItem itemLabel="Seleccione Cita..." itemValue="" />
                        <f:selectItems value="#{pagoBean.listaCitasPendientes}" var="c" 
                                       itemLabel="Cita ##{c.id_cita} - #{c.paciente.usuario.nombre} #{c.paciente.usuario.apellidos}" 
                                       itemValue="#{c.id_cita}" />
                    </p:selectOneMenu>

                    <p:outputLabel for="monto" value="Monto:" />
                    <p:inputNumber id="monto" value="#{pagoBean.pagoActual.monto}" symbol="$ " symbolPosition="p" required="true" />

                    <p:outputLabel for="metodo" value="Método de Pago:" />
                    <p:selectOneMenu id="metodo" value="#{pagoBean.pagoActual.idMetodoPago}" required="true" style="width: 100%">
                        <f:selectItem itemLabel="Efectivo" itemValue="1" />
                        <f:selectItem itemLabel="Tarjeta Crédito" itemValue="2" />
                        <f:selectItem itemLabel="Tarjeta Débito" itemValue="3" />
                        <f:selectItem itemLabel="Transferencia" itemValue="4" />
                        <f:selectItem itemLabel="Nequi/Daviplata" itemValue="6" />
                    </p:selectOneMenu>

                    <p:outputLabel for="ref" value="Referencia (Opcional):" />
                    <p:inputText id="ref" value="#{pagoBean.pagoActual.referencia}" placeholder="Voucher o Nro Transacción" style="width: 100%"/>

                    <p:outputLabel for="notas" value="Notas:" />
                    <p:inputTextarea id="notas" value="#{pagoBean.pagoActual.notas}" rows="3" style="width: 100%"/>

                </h:panelGrid>

                <div style="text-align: center; margin-top: 15px;">
                    <p:commandButton value="Registrar Pago" actionListener="#{pagoBean.guardar()}"
                                     update=":formPagos:tablaPagos :dialogoPago"
                                     oncomplete="if (!args.validationFailed) PF('wDialogoPago').hide();"
                                     icon="pi pi-check" styleClass="ui-button-success" />
                    
                    <p:commandButton value="Cancelar" type="button" onclick="PF('wDialogoPago').hide();"
                                     icon="pi pi-times" styleClass="ui-button-secondary" style="margin-left: 10px;"/>
                </div>
            </h:form>
        </p:dialog>

    </ui:define>
</ui:composition>